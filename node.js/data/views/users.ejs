<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Reports</title>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <h1>File a Report</h1>
    </header>

    <div class="container">
        <div class="alert alert-info">
            <p>Use this form to report incidents, suggest improvements, or request assistance. All reports are reviewed by our team.</p>
        </div>

        <div class="report-form">
            <form id="report-form" onsubmit="submitReport(event)">
                <div class="form-group">
                    <label for="report-type">Report Type</label>
                    <select id="report-type" required class="form-control">
                        <option value="">Select a report type</option>
                        <option value="incident">Incident Report</option>
                        <option value="suggestion">Suggestion</option>
                        <option value="assistance">Request Assistance</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="report-title">Title</label>
                    <input type="text" id="report-title" required placeholder="Brief description of your report">
                </div>

                <div class="form-group">
                    <label for="report-location">Location (if applicable)</label>
                    <input type="text" id="report-location" placeholder="Where did this occur?">
                </div>

                <div class="form-group">
                    <label for="report-description">Description</label>
                    <textarea id="report-description" required rows="5" placeholder="Please provide detailed information"></textarea>
                </div>

                <div class="form-group">
                    <label for="report-urgency">Urgency Level</label>
                    <select id="report-urgency" required>
                        <option value="low">Low - No immediate action required</option>
                        <option value="medium">Medium - Action required within 24 hours</option>
                        <option value="high">High - Urgent attention needed</option>
                        <option value="emergency">Emergency - Immediate response required</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="report-attachment">Attachments (optional)</label>
                    <input type="file" id="report-attachment" multiple>
                    <small>Upload any relevant photos or documents (max 5MB per file)</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="report-anonymous">
                        Submit anonymously
                    </label>
                </div>

                <button type="submit" class="btn">Submit Report</button>
            </form>

            <div id="submission-status" style="display: none;" class="alert"></div>
        </div>

        <div class="card" id="my-reports" style="margin-top: 2rem;">
            <h2>My Previous Reports</h2>
            <div id="reports-list">
                <!-- Previous reports will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        async function submitReport(event) {
            event.preventDefault();
            const statusDiv = document.getElementById('submission-status');
            const form = document.getElementById('report-form');
            
            try {
                const formData = new FormData();
                formData.append('type', document.getElementById('report-type').value);
                formData.append('title', document.getElementById('report-title').value);
                formData.append('location', document.getElementById('report-location').value);
                formData.append('description', document.getElementById('report-description').value);
                formData.append('urgency', document.getElementById('report-urgency').value);
                formData.append('anonymous', document.getElementById('report-anonymous').checked);

                const attachments = document.getElementById('report-attachment').files;
                for (let i = 0; i < attachments.length; i++) {
                    formData.append('attachments', attachments[i]);
                }

                const response = await fetch('/api/reports', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    statusDiv.className = 'alert alert-info';
                    statusDiv.textContent = 'Report submitted successfully!';
                    form.reset();
                    loadPreviousReports(); // Refresh the reports list
                } else {
                    throw new Error('Failed to submit report');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                statusDiv.className = 'alert alert-warning';
                statusDiv.textContent = 'Failed to submit report. Please try again.';
            }

            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        async function loadPreviousReports() {
            try {
                const response = await fetch('/api/reports/my-reports');
                const reports = await response.json();
                
                const reportsList = document.getElementById('reports-list');
                reportsList.innerHTML = reports.length ? reports.map(report => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3>${report.title}</h3>
                        <p><strong>Type:</strong> ${report.type}</p>
                        <p><strong>Status:</strong> ${report.status}</p>
                        <p><strong>Submitted:</strong> ${new Date(report.createdAt).toLocaleDateString()}</p>
                        <button class="btn" onclick="viewReport('${report.id}')">View Details</button>
                    </div>
                `).join('') : '<p>No previous reports found.</p>';
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        // Load previous reports when the page loads
        loadPreviousReports();
    </script>
</body>
</html>