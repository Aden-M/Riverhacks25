<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Law Enforcement Report</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Public Sans',sans-serif;background:#f9f9f9;margin:2rem;text-align:center}
    .container{width:60%;max-width:none;margin:0 auto}
    .welcome-box{display:flex;align-items:center;justify-content:center;gap:1rem;background:#fff;border:1px solid #d6d7d9;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:2rem 3rem;margin-bottom:2rem;font-size:2.2rem;font-weight:700;color:#1b1b1b}
    .logo-img{height:60px;width:auto}
    .report-section{background:#fff;border:1px solid #d6d7d9;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:2rem;margin-bottom:3rem}
    .report-form input[type=text],.report-form input[type=file],.report-form textarea{width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid #ccc;border-radius:6px;font-size:1rem}
    .report-form textarea{height:200px;resize:vertical;overflow-y:auto}
    .btn-brown{background:rgb(101,55,29);color:#fff;border:none;padding:1rem 2rem;border-radius:6px;font-size:1.1rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;width:240px;transition:background .3s,transform .2s;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-top:1rem;margin-bottom:2rem}
    .btn-brown:hover{background:rgba(101,55,29,.85);transform:translateY(-3px)}
    .stripe-bar{width:100%;height:24px;margin:2rem auto;background:rgb(101,55,29);border-radius:4px}
    #popup-message{display:none;font-family:'Public Sans',sans-serif;font-weight:700;font-size:1.4rem;background:#fff;color:#1b1b1b;padding:1rem 2rem;border:2px solid rgb(101,55,29);border-radius:8px;position:fixed;top:20px;left:50%;transform:translateX(-50%);box-shadow:0 4px 10px rgba(0,0,0,.15);z-index:9999;opacity:1;transition:opacity 1s}
    @media(max-width:992px){.container{width:90%}}
  </style>
</head>
<body>
  <div class="container">
    <div class="welcome-box"><img src="/resources/logo.png" alt="Logo" class="logo-img">Law Enforcement Report</div>

    <div class="report-section">
      <form class="report-form" onsubmit="handleReportSubmit(event)">
        <input type="text" id="report-title" placeholder="Report Title" required>
        <input type="text" id="report-location" placeholder="Location and Time" required>
        <textarea id="report-desc" placeholder="Describe the situation..." required></textarea>
        <input type="file" id="report-photo" accept="image/jpeg,image/png,image/webp">
        <button type="submit" class="btn-brown">Submit Report</button>
      </form>
    </div>

    <div class="stripe-bar"></div>
    <button class="btn-brown" onclick="location.href='/'">Return to Home</button>
  </div>

  <div id="popup-message">Report submitted to CityServeATX staff!</div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Initialize Supabase as soon as the library is loaded
    const supabase = window.supabase.createClient(
      'https://yisqddohkvnauykrbyqi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlpc3FkZG9oa3ZuYXV5a3JieXFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTk4ODUsImV4cCI6MjA2MTMzNTg4NX0.z76PFssgGLeQ6qBKnmzTIxSMlsHZ_14GkOZAFUWIWZY'
    );

    async function handleReportSubmit(e){
      e.preventDefault();
      const title=document.getElementById('report-title').value.trim();
      const location=document.getElementById('report-location').value.trim();
      const description=document.getElementById('report-desc').value.trim();
      const file=document.getElementById('report-photo').files[0];
      let imageUrl=null;
      if(file){
        const fileName=`${Date.now()}_${file.name}`;
        const {error:upErr}=await supabase.storage.from('report-photos').upload(fileName,file);
        if(upErr){alert('Photo upload failed');console.error(upErr);return;}
        imageUrl=supabase.storage.from('report-photos').getPublicUrl(fileName).data.publicUrl;
      }
      const {error:insErr}=await supabase.from('reports').insert({title,location,description,image_url:imageUrl});
      if(insErr){alert('Failed to submit report');console.error(insErr);return;}
      showPopup();
      e.target.reset();
    }

    function showPopup(){
      const pop=document.getElementById('popup-message');
      pop.style.display='block';pop.style.opacity='1';
      setTimeout(()=>pop.style.opacity='0',2000);
      setTimeout(()=>{pop.style.display='none';pop.style.opacity='1';},3000);
    }
  </script>
</body>
</html>
